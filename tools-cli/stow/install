#!/bin/bash
# GNU Stow - Symlink farm manager for dotfiles

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../../utils/common.sh"

detect_os

install_stow() {
    if command -v stow &> /dev/null; then
        log_success "GNU Stow is already installed: $(stow --version | head -n1)"
        return 0
    fi
    
    log_info "Installing GNU Stow..."
    
    case "$OS" in
        macos)
            brew install stow
            ;;
        debian|mint)
            safe_apt_update
            safe_sudo apt-get install -y stow
            ;;
        fedora)
            safe_sudo dnf install -y stow
            ;;
        arch)
            safe_sudo pacman -S --noconfirm stow
            ;;
        *)
            log_error "Unsupported OS for automatic stow installation"
            echo "Please install GNU Stow manually:"
            echo "  - macOS: brew install stow"
            echo "  - Debian/Ubuntu: safe_sudo apt install stow"
            echo "  - Fedora: safe_sudo dnf install stow"
            echo "  - Arch: sudo pacman -S stow"
            exit 1
            ;;
    esac
    
    log_success "GNU Stow installed: $(stow --version | head -n1)"
}

show_usage() {
    log_info "GNU Stow Usage Examples:"
    echo
    echo "  # From the dotfiles directory:"
    echo "  stow -t ~ tools-cli/neovim     # Link Neovim configs"
    echo "  stow -D -t ~ tools-cli/neovim  # Remove Neovim configs"
    echo "  stow -R -t ~ tools-cli/neovim  # Relink Neovim configs"
    echo
    echo "  # Preview what would be done:"
    echo "  stow -n -v -t ~ tools-cli/neovim"
    echo
    echo "  # Adopt existing files into stow:"
    echo "  stow --adopt -t ~ tools-cli/neovim"
}

main() {
    detect_os
    install_stow
    echo
    show_usage
}

main "$@"