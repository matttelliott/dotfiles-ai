#!/bin/bash

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../../utils/common.sh"

detect_os

# tmux setup script


install_tmux() {
    log_info "Installing tmux..."
    
    if command -v tmux &> /dev/null; then
        log_info "tmux is already installed: $(tmux -V)"
        return 0
    fi
    
    case "$OS" in
        macos)
            if command -v brew &> /dev/null; then
                brew install tmux
            else
                log_warning "Homebrew not found, please install tmux manually"
                exit 1
            fi
            ;;
        debian|mint)
            safe_sudo apt update
            safe_sudo apt install -y tmux
            ;;
        linux)
            # Generic Linux installation
            if command -v apt &> /dev/null; then
                safe_sudo apt update && safe_sudo apt install -y tmux
            elif command -v yum &> /dev/null; then
                safe_sudo yum install -y tmux
            elif command -v dnf &> /dev/null; then
                safe_sudo dnf install -y tmux
            elif command -v pacman &> /dev/null; then
                sudo pacman -S --noconfirm tmux
            else
                log_warning "Package manager not found, please install tmux manually"
                exit 1
            fi
            ;;
    esac
    
    log_success "tmux installed successfully: $(tmux -V)"
}

setup_tmux_config() {
    log_info "Setting up tmux configuration..."
    
    # Configuration will be handled by stow in the main installer
    # Just install TPM here
    
    # Install TPM (Tmux Plugin Manager) if not already installed
    if [[ ! -d "$HOME/.tmux/plugins/tpm" ]]; then
        log_info "Installing Tmux Plugin Manager (TPM)..."
        git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"
        log_success "TPM installed"
        log_info "Press prefix + I (capital i) in tmux to install plugins"
    else
        log_info "TPM already installed"
    fi
    
    log_info "Note: tmux config will be symlinked via GNU Stow"
}

# Main installation
main() {
    log_info "Setting up tmux..."
    
    install_tmux
    setup_tmux_config
    
    log_success "tmux setup complete!"
    echo
    echo "tmux shortcuts:"
    echo "  • Start new session: tmux new -s name"
    echo "  • List sessions: tmux ls"
    echo "  • Attach to session: tmux attach -t name"
    echo "  • Detach: Ctrl-a d (prefix is remapped from Ctrl-b)"
    echo "  • Install plugins: Ctrl-a I (capital i)"
}

main "$@"
