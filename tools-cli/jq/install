#!/bin/bash

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../../utils/common.sh"

detect_os

install_jq() {
    log_info "Installing jq..."
    
    if command -v jq &> /dev/null; then
        log_info "jq is already installed: $(jq --version)"
        return 0
    fi
    
    case "$OS" in
        macos)
            if command -v brew &> /dev/null; then
                brew install jq
            else
                log_warning "Homebrew not found, installing via curl..."
                curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-macos-amd64 -o /tmp/jq
                chmod +x /tmp/jq
                safe_sudo mv /tmp/jq /usr/local/bin/jq
            fi
            ;;
        debian|mint)
            safe_apt_update
            safe_sudo apt install -y jq
            ;;
        *)
            # Generic Linux installation
            if command -v apt &> /dev/null; then
                safe_apt_update && safe_sudo apt install -y jq
            elif command -v yum &> /dev/null; then
                safe_sudo yum install -y jq
            elif command -v dnf &> /dev/null; then
                safe_sudo dnf install -y jq
            elif command -v pacman &> /dev/null; then
                safe_sudo pacman -S --noconfirm jq
            else
                log_warning "Package manager not found, installing via curl..."
                curl -L https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq
                chmod +x /tmp/jq
                safe_sudo mv /tmp/jq /usr/local/bin/jq
            fi
            ;;
    esac
    
    log_success "jq installed: $(jq --version)"
}

setup_jq_config() {
    log_info "Setting up jq configuration..."
    
    # Create config directory
    mkdir -p "$HOME/.config/jq"
    
    # Link custom jq modules if they exist
    if [[ -f "$PWD/jq/modules.jq" ]]; then
        ln -sf "$PWD/jq/modules.jq" "$HOME/.config/jq/modules.jq"
        log_success "Linked jq custom modules"
    fi
    
    # Link jqrc if it exists (custom startup file)
    if [[ -f "$PWD/jq/jqrc" ]]; then
        ln -sf "$PWD/jq/jqrc" "$HOME/.jqrc"
        log_success "Linked jqrc configuration"
    fi
}

# Main installation
main() {
    log_info "Setting up jq..."
    
    install_jq
    setup_jq_config
    
    # Verify installation
    if command -v jq &> /dev/null; then
        log_success "jq setup complete!"
        echo "Testing jq with sample JSON..."
        echo '{"test": "hello world"}' | jq .
    else
        log_warning "jq installation may have failed"
        exit 1
    fi
}

main "$@"
