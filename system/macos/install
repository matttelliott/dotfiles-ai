#!/bin/bash
# Minimal macOS system setup
# ONLY installs base tools needed by other installers

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../../utils/common.sh"

detect_os

# Install Xcode Command Line Tools
install_xcode_tools() {
    log_info "Checking for Xcode Command Line Tools..."
    
    if xcode-select -p &> /dev/null; then
        log_info "Xcode Command Line Tools already installed"
    else
        log_info "Installing Xcode Command Line Tools..."
        xcode-select --install
        
        # Wait for installation to complete
        until xcode-select -p &> /dev/null; do
            sleep 5
        done
        
        log_success "Xcode Command Line Tools installed"
    fi
}

# Install Homebrew
install_homebrew() {
    log_info "Checking for Homebrew..."
    
    if command -v brew &> /dev/null; then
        log_info "Homebrew already installed"
        brew update
    else
        log_info "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        
        # Add Homebrew to PATH for Apple Silicon Macs
        if [[ -f "/opt/homebrew/bin/brew" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        fi
        
        log_success "Homebrew installed"
    fi
}

# Main
main() {
    log_info "Running minimal macOS system setup..."
    install_xcode_tools
    install_homebrew
    log_success "macOS base setup complete!"
}

main "$@"