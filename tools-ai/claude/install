#!/bin/bash

# Claude Code installation and configuration
# Configures Claude Code with MCP servers according to official documentation
# Part of dotfiles-ai repository

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../../utils/common.sh"

detect_os

# Configuration
DOTFILES_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
CLAUDE_DIR="$SCRIPT_DIR"

log_info "Configuring Claude Code with MCP servers..."

# Check if running in a desktop environment for Claude Desktop
has_desktop_environment() {
    if [[ -n "$DISPLAY" ]] || [[ -n "$WAYLAND_DISPLAY" ]] || [[ -n "$XDG_CURRENT_DESKTOP" ]]; then
        return 0
    fi
    
    if [[ "$OS" == "macos" ]]; then
        return 0
    fi
    
    if command -v startx &>/dev/null || command -v gdm &>/dev/null || command -v lightdm &>/dev/null; then
        return 0
    fi
    
    return 1
}

# Install Node.js if needed (required for MCP servers)
install_node() {
    if command -v node &>/dev/null; then
        log_success "Node.js already installed: $(node --version)"
        return 0
    fi
    
    log_info "Installing Node.js via nvm..."
    if [[ -x "$DOTFILES_DIR/tools-lang/node/install" ]]; then
        "$DOTFILES_DIR/tools-lang/node/install"
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    else
        log_error "Cannot install Node.js. Please install manually."
        exit 1
    fi
}

# Install MCP server dependencies
install_mcp_server_deps() {
    local server_dir="$1"
    local server_name=$(basename "$server_dir")
    
    log_info "Installing dependencies for $server_name..."
    
    cd "$server_dir"
    
    # Install npm dependencies if package.json exists
    if [[ -f package.json ]]; then
        # Always ensure MCP SDK is installed
        log_info "Installing dependencies for $server_name..."
        npm install @modelcontextprotocol/sdk zod zod-to-json-schema
        
        # Install any other dependencies
        if [[ ! -d node_modules ]] || [[ ! -f package-lock.json ]]; then
            npm install --production
        else
            log_info "Core dependencies already installed for $server_name"
        fi
    fi
    
    # Make server executable
    if [[ -f server.js ]]; then
        chmod +x server.js
    fi
    
    # Make test script executable if it exists
    if [[ -f test-server.js ]]; then
        chmod +x test-server.js
    fi
}

# Install MCP servers
install_mcp_servers() {
    log_info "Installing MCP servers..."
    
    # Install tmux MCP server
    if [[ -d "$DOTFILES_DIR/tools-ai/mcp-tmux" ]]; then
        log_info "Installing mcp-tmux..."
        install_mcp_server_deps "$DOTFILES_DIR/tools-ai/mcp-tmux"
        
        # Check if tmux is installed
        if ! command -v tmux &>/dev/null; then
            log_warning "tmux not installed. Installing tmux..."
            if [[ "$OS" == "macos" ]]; then
                brew install tmux
            else
                sudo apt-get update && sudo apt-get install -y tmux
            fi
        fi
    fi
    
    # Install neovim MCP server
    if [[ -d "$DOTFILES_DIR/tools-ai/mcp-neovim" ]]; then
        log_info "Installing mcp-neovim..."
        install_mcp_server_deps "$DOTFILES_DIR/tools-ai/mcp-neovim"
        
        # Check if neovim is installed
        if ! command -v nvim &>/dev/null; then
            log_warning "Neovim not installed. You may want to install it for mcp-neovim to work."
            log_info "Install with: ./tools-cli/neovim/install"
        fi
    fi
    
    # Install playwright MCP server
    if [[ -d "$DOTFILES_DIR/tools-ai/mcp-playwright" ]]; then
        log_info "Installing mcp-playwright..."
        install_mcp_server_deps "$DOTFILES_DIR/tools-ai/mcp-playwright"
        
        # Install playwright browsers if needed
        cd "$DOTFILES_DIR/tools-ai/mcp-playwright"
        if [[ -f node_modules/.bin/playwright ]]; then
            log_info "Installing Playwright browsers..."
            npx playwright install chromium
        fi
    fi
    
    log_success "MCP servers installed"
}

# Create Claude configuration files
create_config_files() {
    log_info "Creating Claude Code configuration files..."
    
    # Ensure the .claude directory exists in the stow structure
    mkdir -p "$CLAUDE_DIR/.claude"
    
    # Create settings.json with Claude configuration (without AWS/Vertex bits that break auth)
    cat > "$CLAUDE_DIR/.claude/settings.json" << EOF
{
  "model": "claude-3-5-sonnet-20241022",
  "permissions": {
    "allow": [
      "Bash(ls:*)",
      "Bash(mv:*)",
      "Bash(mkdir:*)",
      "Bash(chmod:*)",
      "Bash(./install*)",
      "Bash(stow:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(npm install:*)",
      "Bash(node:*)",
      "Bash(claude mcp:*)"
    ],
    "deny": []
  },
  "env": {
    "DOTFILES_DIR": "$DOTFILES_DIR"
  },
  "features": {
    "autoSave": true,
    "confirmBeforeRun": false,
    "syntaxHighlighting": true,
    "notificationStyle": "minimal"
  }
}
EOF
    
    log_success "Configuration file created (settings.json)"
}

# Setup Claude Desktop config if desktop environment exists
setup_claude_desktop() {
    if ! has_desktop_environment; then
        log_info "No desktop environment detected, skipping Claude Desktop config"
        return 0
    fi
    
    log_info "Setting up Claude Desktop configuration..."
    
    # Determine Claude Desktop config location based on OS
    local desktop_config_dir
    case "$OS" in
        macos)
            desktop_config_dir="$HOME/Library/Application Support/Claude"
            ;;
        *)
            desktop_config_dir="$HOME/.config/claude"
            ;;
    esac
    
    # Create directory if it doesn't exist
    mkdir -p "$desktop_config_dir"
    
    # Create Claude Desktop config (without MCP servers - they're registered via CLI)
    cat > "$desktop_config_dir/claude_desktop_config.json" << EOF
{
  "theme": "auto",
  "telemetry": false,
  "autoUpdate": true
}
EOF
    
    log_success "Claude Desktop configured at $desktop_config_dir/claude_desktop_config.json"
}

# Use GNU Stow to symlink configs
stow_configs() {
    log_info "Stowing Claude Code configuration..."
    
    # Ensure GNU Stow is installed
    if ! command -v stow &>/dev/null; then
        log_warning "GNU Stow not installed. Installing..."
        if [[ "$OS" == "macos" ]]; then
            brew install stow
        else
            sudo apt-get update && sudo apt-get install -y stow
        fi
    fi
    
    # Navigate to tools-ai directory for stowing
    cd "$DOTFILES_DIR/tools-ai"
    
    # Remove any existing symlinks that might conflict
    if [[ -L "$HOME/.claude/settings.json" ]]; then
        rm "$HOME/.claude/settings.json"
    fi
    
    # Backup existing settings if they exist and aren't symlinks
    if [[ -f "$HOME/.claude/settings.json" && ! -L "$HOME/.claude/settings.json" ]]; then
        log_info "Backing up existing settings.json..."
        mv "$HOME/.claude/settings.json" "$HOME/.claude/settings.json.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # Create .claude directory if it doesn't exist
    mkdir -p "$HOME/.claude"
    
    # Stow the Claude configs (this will symlink both settings.json and .mcp.json)
    stow -v -R -t "$HOME" claude
    
    log_success "Configuration files stowed"
}

# Create symlinks for MCP servers where Claude might expect them
create_mcp_symlinks() {
    log_info "Creating MCP server symlinks..."
    
    # Create mcp-servers directory if it doesn't exist
    if [[ -L "$HOME/mcp-servers" ]]; then
        rm "$HOME/mcp-servers"
    fi
    mkdir -p "$HOME/mcp-servers"
    
    # Create symlinks for each MCP server
    ln -sf "$DOTFILES_DIR/tools-ai/mcp-tmux" "$HOME/mcp-servers/tmux"
    ln -sf "$DOTFILES_DIR/tools-ai/mcp-neovim" "$HOME/mcp-servers/neovim"
    ln -sf "$DOTFILES_DIR/tools-ai/mcp-playwright" "$HOME/mcp-servers/playwright"
    
    log_success "MCP server symlinks created"
}

# Configure MCP servers globally in ~/.claude.json
configure_mcp_servers() {
    log_info "Configuring MCP servers globally..."
    
    local config_file="$HOME/.claude.json"
    
    # Check if .claude.json exists
    if [[ -f "$config_file" ]]; then
        # Backup existing file
        log_info "Backing up existing ~/.claude.json..."
        cp "$config_file" "${config_file}.backup.$(date +%Y%m%d_%H%M%S)"
        
        # Check if jq is available for JSON manipulation
        if ! command -v jq &>/dev/null; then
            log_info "Installing jq for JSON manipulation..."
            if [[ "$OS" == "macos" ]]; then
                brew install jq
            else
                sudo apt-get update && sudo apt-get install -y jq
            fi
        fi
        
        # Add or update mcpServers in the existing config
        jq --arg tmux "$DOTFILES_DIR/tools-ai/mcp-tmux/server.js" \
           --arg neovim "$DOTFILES_DIR/tools-ai/mcp-neovim/server.js" \
           --arg playwright "$DOTFILES_DIR/tools-ai/mcp-playwright/server.js" \
           --arg browsers "$HOME/.cache/ms-playwright" \
           '.mcpServers = {
              "tmux": {
                "type": "stdio",
                "command": "node",
                "args": [$tmux],
                "env": {"NODE_ENV": "production"}
              },
              "neovim": {
                "type": "stdio",
                "command": "node", 
                "args": [$neovim],
                "env": {"NODE_ENV": "production", "NVIM_LISTEN_ADDRESS": "/tmp/nvim.pipe"}
              },
              "playwright": {
                "type": "stdio",
                "command": "node",
                "args": [$playwright],
                "env": {"NODE_ENV": "production", "PLAYWRIGHT_BROWSERS_PATH": $browsers}
              }
            }' "${config_file}.backup.$(date +%Y%m%d_%H%M%S)" > "$config_file"
    else
        # Create new .claude.json with mcpServers
        cat > "$config_file" << EOF
{
  "mcpServers": {
    "tmux": {
      "type": "stdio",
      "command": "node",
      "args": ["$DOTFILES_DIR/tools-ai/mcp-tmux/server.js"],
      "env": {
        "NODE_ENV": "production"
      }
    },
    "neovim": {
      "type": "stdio",
      "command": "node",
      "args": ["$DOTFILES_DIR/tools-ai/mcp-neovim/server.js"],
      "env": {
        "NODE_ENV": "production",
        "NVIM_LISTEN_ADDRESS": "/tmp/nvim.pipe"
      }
    },
    "playwright": {
      "type": "stdio",
      "command": "node",
      "args": ["$DOTFILES_DIR/tools-ai/mcp-playwright/server.js"],
      "env": {
        "NODE_ENV": "production",
        "PLAYWRIGHT_BROWSERS_PATH": "$HOME/.cache/ms-playwright"
      }
    }
  }
}
EOF
    fi
    
    log_success "MCP servers configured globally in ~/.claude.json"
    log_info "MCP servers will be available in all projects"
}

# Test MCP servers
test_mcp_servers() {
    log_info "Testing MCP servers..."
    
    # Check if claude CLI is available
    if ! command -v claude &>/dev/null; then
        log_warning "Claude CLI not found. Skipping MCP server tests."
        return 1
    fi
    
    # List registered MCP servers
    log_info "Listing registered MCP servers..."
    claude mcp list 2>&1
    
    log_success "MCP server testing complete"
}

# Create diagnostic script
create_diagnostic_script() {
    log_info "Creating diagnostic script..."
    
    cat > "$CLAUDE_DIR/diagnose.sh" << 'EOF'
#!/bin/bash

echo "Claude Code Configuration Diagnostic"
echo "===================================="
echo ""

DOTFILES_DIR="$(cd "$(dirname "$0")/../.." && pwd)"

# Check Node.js
echo "Node.js:"
if command -v node &>/dev/null; then
    echo "  ✓ $(node --version)"
else
    echo "  ✗ Not installed"
fi

# Check Claude Code settings
echo ""
echo "Claude Code Settings:"
if [[ -f ~/.claude/settings.json ]]; then
    echo "  ✓ User settings exists"
    if [[ -L ~/.claude/settings.json ]]; then
        echo "    Symlinked to: $(readlink ~/.claude/settings.json)"
    fi
    
    # Check if MCP servers are configured
    if command -v jq &>/dev/null; then
        echo "  MCP servers configured:"
        jq -r '.mcpServers | keys[]' ~/.claude/settings.json 2>/dev/null | sed 's/^/    - /'
    fi
else
    echo "  ✗ User settings not found"
fi

# Check MCP servers via Claude CLI
if command -v claude &>/dev/null; then
    echo ""
    echo "MCP Servers (via Claude CLI):"
    claude mcp list 2>&1 | sed 's/^/  /'
else
    echo "  ℹ Claude CLI not found - cannot check MCP server status"
fi

# Check authentication
if [[ -f ~/.claude/.credentials.json ]]; then
    echo "  ✓ Authentication credentials exist"
else
    echo "  ℹ No authentication credentials found (run 'claude login' to authenticate)"
fi

# Check MCP servers
echo ""
echo "MCP Server Status:"
for server in tmux neovim playwright; do
    server_path="$DOTFILES_DIR/tools-ai/mcp-$server/server.js"
    echo -n "  $server: "
    if [[ -f "$server_path" ]]; then
        echo -n "✓ installed"
        if [[ -d "$(dirname "$server_path")/node_modules" ]]; then
            echo " (dependencies ✓)"
        else
            echo " (missing dependencies)"
        fi
    else
        echo "✗ not found"
    fi
done

# Check required tools
echo ""
echo "Required Tools:"
echo -n "  tmux: "
command -v tmux &>/dev/null && echo "✓ $(tmux -V)" || echo "✗ not installed"
echo -n "  neovim: "
command -v nvim &>/dev/null && echo "✓ $(nvim --version | head -1)" || echo "✗ not installed"

# Check Claude Desktop config
echo ""
echo "Claude Desktop:"
DESKTOP_CONFIG=""
if [[ -f "$HOME/Library/Application Support/Claude/claude_desktop_config.json" ]]; then
    DESKTOP_CONFIG="$HOME/Library/Application Support/Claude/claude_desktop_config.json"
    echo "  ✓ Config exists (macOS)"
elif [[ -f "$HOME/.config/claude/claude_desktop_config.json" ]]; then
    DESKTOP_CONFIG="$HOME/.config/claude/claude_desktop_config.json"
    echo "  ✓ Config exists (Linux)"
else
    echo "  ℹ Config not found (desktop environment may not be available)"
fi

echo ""
echo "Quick Test Commands:"
echo "  Test MCP servers: claude mcp list"
echo "  View settings: claude config list"
echo "  Login to Claude: claude login"
EOF
    
    chmod +x "$CLAUDE_DIR/diagnose.sh"
    
    log_success "Diagnostic script created"
}

# Main installation flow
main() {
    log_info "Starting Claude Code configuration..."
    
    # Install dependencies
    install_node
    
    # Install and configure MCP servers
    install_mcp_servers
    
    # Create configuration files
    create_config_files
    
    # Setup Claude Desktop if applicable
    setup_claude_desktop
    
    # Stow configurations
    stow_configs
    
    # Configure MCP servers globally
    configure_mcp_servers
    
    # Create symlinks for MCP servers
    create_mcp_symlinks
    
    # Test MCP servers
    test_mcp_servers
    
    # Create diagnostic script
    create_diagnostic_script
    
    log_success "Claude Code configuration complete!"
    echo ""
    log_info "Configuration Status:"
    echo "  ✓ User settings: ~/.claude/settings.json"
    echo "  ✓ Global MCP servers: ~/.claude.json"
    has_desktop_environment && echo "  ✓ Desktop config: ~/.config/claude/claude_desktop_config.json (or ~/Library/... on macOS)"
    echo ""
    log_info "MCP Servers Configured (global - all projects):"
    echo "  - tmux: Terminal multiplexer control"
    echo "  - neovim: Neovim editor integration"
    echo "  - playwright: Browser automation"
    echo ""
    log_info "Next steps:"
    echo "  1. Authenticate Claude Code: claude login"
    echo "  2. Test MCP servers: claude mcp list"
    echo "  3. Run diagnostics: $CLAUDE_DIR/diagnose.sh"
    echo ""
    log_success "Installation complete! MCP servers are available globally in all projects."
}

# Run main installation
main "$@"