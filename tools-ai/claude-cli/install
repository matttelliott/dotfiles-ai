#!/usr/bin/env bash

# Claude CLI Installation Script with MCP Server Integration
# Part of dotfiles-ai repository

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../../utils/common.sh"

detect_os

# Configuration
DOTFILES_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
CLAUDE_CLI_DIR="$SCRIPT_DIR"

log_info "Installing Claude CLI with MCP server integration..."

# Check dependencies
check_dependencies() {
    log_info "Checking dependencies..."
    
    # Check if Node.js is installed (required for MCP servers)
    if ! command -v node >/dev/null 2>&1; then
        log_warning "Node.js not found. Installing via nvm..."
        if [[ -x "$DOTFILES_DIR/tools-lang/node/install" ]]; then
            "$DOTFILES_DIR/tools-lang/node/install"
        else
            log_error "Cannot install Node.js. Please install manually."
            exit 1
        fi
    fi
    
    log_success "Dependencies satisfied"
}

# Install Claude CLI if not already installed
install_claude_cli() {
    if command -v claude >/dev/null 2>&1; then
        log_success "Claude CLI is already installed ($(claude --version))"
        return 0
    fi
    
    log_info "Installing Claude CLI..."
    
    # Claude CLI can be installed via npm
    if command -v npm >/dev/null 2>&1; then
        npm install -g @anthropic-ai/claude-cli
        log_success "Claude CLI installed via npm"
    else
        log_error "npm not found. Please install Node.js first."
        exit 1
    fi
}

# Setup configuration directories
setup_config_dirs() {
    log_info "Setting up configuration directories..."
    
    # Create actual config directories
    mkdir -p "$HOME/.config/claude-cli"
    
    log_success "Configuration directories created"
}

# Create Claude CLI configuration with MCP servers
create_cli_config() {
    log_info "Creating Claude CLI configuration..."
    
    local config_file="$HOME/.config/claude-cli/config.json"
    
    # Backup existing config if it exists
    if [[ -f "$config_file" ]] && ! grep -q "dotfiles-ai/tools-ai" "$config_file" 2>/dev/null; then
        log_info "Backing up existing configuration..."
        cp "$config_file" "$config_file.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # Create main CLI config
    cat > "$config_file" << EOF
{
  "defaultModel": "claude-3-5-sonnet-20241022",
  "mcpServers": {
    "tmux": {
      "command": "node",
      "args": ["$DOTFILES_DIR/tools-ai/mcp-tmux/server.js"],
      "env": {
        "NODE_ENV": "production"
      }
    },
    "neovim": {
      "command": "node",
      "args": ["$DOTFILES_DIR/tools-ai/mcp-neovim/server.js"],
      "env": {
        "NODE_ENV": "production"
      }
    },
    "playwright": {
      "command": "node",
      "args": ["$DOTFILES_DIR/tools-ai/mcp-playwright/server.js"],
      "env": {
        "NODE_ENV": "production",
        "PLAYWRIGHT_BROWSERS_PATH": "$HOME/.cache/ms-playwright"
      }
    }
  },
  "features": {
    "autoSave": true,
    "confirmBeforeRun": false,
    "syntaxHighlighting": true
  }
}
EOF
    
    log_success "Claude CLI configuration created"
}

# Create project-specific MCP configuration
create_project_mcp_config() {
    log_info "Creating project MCP configuration..."
    
    # This creates a template that users can copy to their projects
    local template_file="$CLAUDE_CLI_DIR/mcp-template.json"
    
    cat > "$template_file" << EOF
{
  "mcpServers": {
    "tmux": {
      "command": "node",
      "args": ["$DOTFILES_DIR/tools-ai/mcp-tmux/server.js"],
      "env": {
        "NODE_ENV": "production"
      }
    },
    "neovim": {
      "command": "node",
      "args": ["$DOTFILES_DIR/tools-ai/mcp-neovim/server.js"],
      "env": {
        "NODE_ENV": "production"
      }
    },
    "playwright": {
      "command": "node",
      "args": ["$DOTFILES_DIR/tools-ai/mcp-playwright/server.js"],
      "env": {
        "NODE_ENV": "production",
        "PLAYWRIGHT_BROWSERS_PATH": "$HOME/.cache/ms-playwright"
      }
    }
  }
}
EOF
    
    log_success "Project MCP template created at $template_file"
    
    # Also update the dotfiles repo's own .mcp.json
    if [[ "$PWD" == "$DOTFILES_DIR" ]]; then
        log_info "Updating dotfiles repository .mcp.json..."
        cp "$template_file" "$DOTFILES_DIR/.mcp.json"
    fi
}

# Install all MCP servers
install_mcp_servers() {
    log_info "Installing MCP servers..."
    
    local servers=("mcp-tmux" "mcp-neovim" "mcp-playwright")
    
    for server in "${servers[@]}"; do
        if [[ -x "$DOTFILES_DIR/tools-ai/$server/install" ]]; then
            log_info "Installing $server..."
            "$DOTFILES_DIR/tools-ai/$server/install"
        else
            log_warning "$server installer not found, skipping..."
        fi
    done
    
    log_success "MCP servers installed"
}

# No stow needed - configs are written directly
finalize_configs() {
    log_info "Finalizing configuration..."
    
    # Set proper permissions
    chmod 600 "$HOME/.config/claude-cli/config.json" 2>/dev/null || true
    
    log_success "Configuration finalized"
}

# Create convenience scripts
create_scripts() {
    log_info "Creating convenience scripts..."
    
    # Create test script
    cat > "$CLAUDE_CLI_DIR/test-mcp.sh" << 'EOF'
#!/usr/bin/env bash

# Test MCP server connectivity for Claude CLI

echo "Testing MCP server connectivity..."
echo ""

# Test tmux server
echo "Testing tmux MCP server..."
if node "$DOTFILES_DIR/tools-ai/mcp-tmux/server.js" --test 2>/dev/null; then
    echo "✓ Tmux MCP server is functional"
else
    echo "✗ Tmux MCP server failed"
fi

# Test neovim server
echo "Testing neovim MCP server..."
if node "$DOTFILES_DIR/tools-ai/mcp-neovim/server.js" --test 2>/dev/null; then
    echo "✓ Neovim MCP server is functional"
else
    echo "✗ Neovim MCP server failed"
fi

# Test playwright server
echo "Testing playwright MCP server..."
if node "$DOTFILES_DIR/tools-ai/mcp-playwright/server.js" --test 2>/dev/null; then
    echo "✓ Playwright MCP server is functional"
else
    echo "✗ Playwright MCP server failed"
fi

echo ""
echo "Testing Claude CLI MCP integration..."
claude mcp list
EOF
    
    chmod +x "$CLAUDE_CLI_DIR/test-mcp.sh"
    
    log_success "Scripts created"
}

# Main installation
main() {
    log_info "Starting Claude CLI installation with MCP integration..."
    
    check_dependencies
    install_claude_cli
    setup_config_dirs
    create_cli_config
    create_project_mcp_config
    install_mcp_servers
    finalize_configs
    create_scripts
    
    log_success "Claude CLI installation complete!"
    echo ""
    log_info "Next steps:"
    echo "  1. Authenticate: claude auth login"
    echo "  2. Test MCP servers: $CLAUDE_CLI_DIR/test-mcp.sh"
    echo "  3. List MCP servers: claude mcp list"
    echo "  4. Start using: claude chat"
    echo ""
    log_info "Configuration locations:"
    echo "  CLI config: ~/.config/claude-cli/config.json"
    echo "  Project MCP template: $CLAUDE_CLI_DIR/mcp-template.json"
    echo "  Project MCP (this repo): $DOTFILES_DIR/.mcp.json"
}

main "$@"