#!/bin/bash

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../../utils/common.sh"

detect_os

# AI Model Configurations setup script - Centralized LLM configuration management

create_model_select_script() {
    log_info "Creating ai-model-select helper script..."
    
    cat > "$HOME/.local/bin/ai-model-select" << 'EOF'
#!/bin/bash
# AI Model Selection Helper

CONFIG_DIR="$HOME/.config/ai-models"

show_usage() {
    echo "Usage: ai-model-select [provider] [model]"
    echo ""
    echo "Available providers:"
    for config in "$CONFIG_DIR"/*-config.json; do
        if [[ -f "$config" ]]; then
            provider=$(basename "$config" | sed 's/-config.json//')
            echo "  $provider"
        fi
    done
    echo ""
    echo "Examples:"
    echo "  ai-model-select claude                 # List Claude models"
    echo "  ai-model-select claude opus           # Set Claude Opus as default"
    echo "  ai-model-select openai gpt-4          # Set GPT-4 as default"
}

list_models() {
    local provider="$1"
    local config_file="$CONFIG_DIR/${provider}-config.json"
    
    if [[ ! -f "$config_file" ]]; then
        echo "Error: Configuration file not found for provider: $provider"
        exit 1
    fi
    
    echo "Available models for $provider:"
    if command -v jq >/dev/null 2>&1; then
        jq -r '.available_models[]? | "\(.id) - \(.name)"' "$config_file" 2>/dev/null || echo "Unable to parse models from config"
    else
        echo "Install jq to list available models, or view config manually:"
        echo "cat $config_file"
    fi
}

set_default_model() {
    local provider="$1"
    local model="$2"
    local config_file="$CONFIG_DIR/${provider}-config.json"
    
    if [[ ! -f "$config_file" ]]; then
        echo "Error: Configuration file not found for provider: $provider"
        exit 1
    fi
    
    if command -v jq >/dev/null 2>&1; then
        # Update the default model in the config
        jq --arg model "$model" '.default_model = $model' "$config_file" > "${config_file}.tmp" && mv "${config_file}.tmp" "$config_file"
        echo "Set default model for $provider to: $model"
    else
        echo "jq is required to modify configurations. Please install jq or edit manually:"
        echo "Edit: $config_file"
    fi
}

case "${1:-}" in
    ""|"-h"|"--help")
        show_usage
        ;;
    *)
        if [[ -z "${2:-}" ]]; then
            list_models "$1"
        else
            set_default_model "$1" "$2"
        fi
        ;;
esac
EOF
    
    mkdir -p "$HOME/.local/bin"
    chmod +x "$HOME/.local/bin/ai-model-select"
    
    log_success "Created ai-model-select helper script"
}

install_dependencies() {
    log_info "Checking dependencies..."
    
    # Check if jq is installed for JSON manipulation
    if ! command -v jq &> /dev/null; then
        log_info "Installing jq for JSON configuration management..."
        
        case "$OS" in
            macos)
                if command -v brew &> /dev/null; then
                    brew install jq
                else
                    log_warning "Homebrew not found. Please install jq manually: https://stedolan.github.io/jq/"
                fi
                ;;
        debian|mint)
                safe_sudo apt update
                safe_sudo apt install -y jq
                ;;
            linux)
                if command -v apt &> /dev/null; then
                    safe_sudo apt update && safe_sudo apt install -y jq
                elif command -v dnf &> /dev/null; then
                    safe_sudo dnf install -y jq
                elif command -v pacman &> /dev/null; then
                    sudo pacman -S --noconfirm jq
                else
                    log_warning "Package manager not recognized. Please install jq manually."
                fi
                ;;
        esac
        
        if command -v jq &> /dev/null; then
            log_success "jq installed successfully"
        else
            log_warning "jq installation failed. Some features may not work."
        fi
    else
        log_success "jq is already installed"
    fi
}

setup_model_configs() {
    log_info "Setting up AI model configuration files..."
    
    local config_dir="$HOME/.config/ai-models"
    mkdir -p "$config_dir"
    
    # Claude configuration
    cat > "$config_dir/claude-config.json" << 'EOF'
{
  "provider": "claude",
  "api_key_env": "ANTHROPIC_API_KEY",
  "base_url": "https://api.anthropic.com",
  "default_model": "claude-3-sonnet-20240229",
  "available_models": [
    {
      "id": "claude-3-opus-20240229",
      "name": "Claude 3 Opus",
      "context_window": 200000,
      "description": "Most capable model for complex tasks"
    },
    {
      "id": "claude-3-sonnet-20240229", 
      "name": "Claude 3 Sonnet",
      "context_window": 200000,
      "description": "Balanced performance and speed"
    },
    {
      "id": "claude-3-haiku-20240307",
      "name": "Claude 3 Haiku",
      "context_window": 200000,
      "description": "Fast and efficient for simple tasks"
    }
  ]
}
EOF

    # OpenAI configuration
    cat > "$config_dir/openai-config.json" << 'EOF'
{
  "provider": "openai",
  "api_key_env": "OPENAI_API_KEY",
  "base_url": "https://api.openai.com/v1",
  "default_model": "gpt-4",
  "available_models": [
    {
      "id": "gpt-4",
      "name": "GPT-4",
      "context_window": 8192,
      "description": "Most capable GPT-4 model"
    },
    {
      "id": "gpt-4-32k",
      "name": "GPT-4 32K",
      "context_window": 32768,
      "description": "GPT-4 with extended context"
    },
    {
      "id": "gpt-3.5-turbo",
      "name": "GPT-3.5 Turbo",
      "context_window": 4096,
      "description": "Fast and efficient chat model"
    }
  ]
}
EOF

    # Ollama configuration
    cat > "$config_dir/ollama-config.json" << 'EOF'
{
  "provider": "ollama",
  "api_key_env": "",
  "base_url": "http://localhost:11434",
  "default_model": "llama2",
  "available_models": [
    {
      "id": "llama2",
      "name": "Llama 2",
      "context_window": 4096,
      "description": "Meta's Llama 2 model"
    },
    {
      "id": "codellama",
      "name": "Code Llama",
      "context_window": 4096,
      "description": "Code-specialized Llama model"
    },
    {
      "id": "mistral",
      "name": "Mistral",
      "context_window": 8192,
      "description": "Mistral AI model"
    }
  ]
}
EOF

    log_success "AI model configuration files created"
}

setup_environment_variables() {
    log_info "Setting up environment variables..."
    
    local env_config='
# AI Models Configuration
export AI_MODELS_CONFIG_DIR="$HOME/.config/ai-models"
export DEFAULT_AI_PROVIDER="claude"
export DEFAULT_CLAUDE_MODEL="claude-3-sonnet-20240229"
export DEFAULT_OPENAI_MODEL="gpt-4"
export DEFAULT_OLLAMA_MODEL="llama2"

# AI model helper functions
ai-config-claude() { cat "$AI_MODELS_CONFIG_DIR/claude-config.json"; }
ai-config-openai() { cat "$AI_MODELS_CONFIG_DIR/openai-config.json"; }
ai-config-ollama() { cat "$AI_MODELS_CONFIG_DIR/ollama-config.json"; }
ai-config-list() { ls -la "$AI_MODELS_CONFIG_DIR"/*.json; }
'
    
    # Add to shell RC files
    for rc_file in "$HOME/.zshrc" "$HOME/.bashrc"; do
        if [[ -f "$rc_file" ]]; then
            if ! grep -q "AI_MODELS_CONFIG_DIR" "$rc_file"; then
                echo "$env_config" >> "$rc_file"
                log_success "Added AI environment variables to $(basename $rc_file)"
            else
                log_info "AI environment variables already configured in $(basename $rc_file)"
            fi
        fi
    done
}

create_helper_scripts() {
    log_info "Creating additional helper scripts..."
    
    mkdir -p "$HOME/.local/bin"
    
    # Already created ai-model-select in create_model_select_script
    create_model_select_script
    
    log_success "Helper scripts created"
}

# Main installation
main() {
    log_info "Setting up AI model configurations..."
    
    install_dependencies
    setup_model_configs
    setup_environment_variables
    create_helper_scripts
    
    log_success "AI model configurations setup complete!"
    echo
    echo "AI Model Configurations - Centralized LLM configuration management"
    echo
    echo "Configuration files created in: $HOME/.config/ai-models/"
    echo
    echo "Available commands:"
    echo "  ai-model-select           - Interactive model selection"
    echo "  ai-config-claude          - View Claude configuration"
    echo "  ai-config-openai          - View OpenAI configuration"
    echo "  ai-config-ollama          - View Ollama configuration"
    echo "  ai-config-list            - List all configuration files"
    echo
    echo "Environment variables set:"
    echo "  AI_MODELS_CONFIG_DIR      - Configuration directory"
    echo "  DEFAULT_AI_PROVIDER       - Default provider (claude)"
    echo "  DEFAULT_CLAUDE_MODEL      - Default Claude model"
    echo "  DEFAULT_OPENAI_MODEL      - Default OpenAI model"
    echo
    echo "Restart your shell or run 'source ~/.zshrc' to load new configurations"
}

main "$@"
